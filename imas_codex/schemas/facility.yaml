# Fusion Facility Schema (Unified)
#
# This schema defines ALL facility data - both public (graphed) and private.
# Fields marked with `is_private: true` are:
#   - Stored in <facility>_private.yaml (gitignored)
#   - NEVER written to the Neo4j graph
#   - NEVER included in OCI artifact pushes
#
# Public fields are stored in <facility>.yaml and the graph.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force
#
# VERSIONING: The version field below is kept in sync with the project version.
# The release workflow updates both together. Do not manually edit the version.

id: https://imas.iter.org/schemas/facility
name: facility
title: Fusion Facility Schema (Unified)
description: >-
  Unified schema for fusion research facilities. Fields with is_private: true
  are stored locally only (gitignored YAML), never in the public graph.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  facility: https://imas.iter.org/schemas/facility/
  imas: https://imas.iter.org/

default_prefix: facility
default_range: string

imports:
  - linkml:types
  - common
  - imas_dd

# =============================================================================
# Enums
# =============================================================================

enums:
  DataSourceType:
    description: Types of data source systems at fusion facilities
    permissible_values:
      mdsplus:
        description: MDSplus tree-based data system
      uda:
        description: Universal Data Access (UDA) system
      hdf5:
        description: HDF5 file-based storage
      netcdf:
        description: NetCDF scientific data format
      imas:
        description: IMAS native data format
      ppf:
        description: JET Processed Pulse File system
      allas:
        description: CSC Allas object storage

  ToolStatus:
    description: Availability status of a command-line tool
    permissible_values:
      available:
        description: Tool is installed and accessible
      unavailable:
        description: Tool is not installed
      restricted:
        description: Tool exists but requires special access

  TreeNodeType:
    description: MDSplus node data types
    permissible_values:
      STRUCTURE:
        description: Container node with no data
      SIGNAL:
        description: Time-varying measurement data
      NUMERIC:
        description: Numeric scalar or array
      TEXT:
        description: Text/string data
      AXIS:
        description: Coordinate axis data
      SUBTREE:
        description: Reference to another tree
      ACTION:
        description: Action sequence node
      DISPATCH:
        description: Dispatch scheduling node
      TASK:
        description: Task definition node

  DiagnosticCategory:
    description: Categories of fusion plasma diagnostics
    permissible_values:
      magnetics:
        description: Magnetic field and flux measurements
      spectroscopy:
        description: Spectroscopic diagnostics (visible, UV, X-ray)
      particle:
        description: Particle diagnostics (CX, NPA, beam emission)
      imaging:
        description: Camera and imaging systems
      microwave:
        description: Microwave diagnostics (ECE, reflectometry)
      bolometry:
        description: Radiated power measurements
      neutron:
        description: Neutron flux and spectrum diagnostics
      probe:
        description: Langmuir probes and other insertable probes
      interferometry:
        description: Interferometric density measurements
      thomson:
        description: Thomson scattering systems

  AnalysisCodeType:
    description: Types of physics analysis codes
    permissible_values:
      equilibrium:
        description: Equilibrium reconstruction (EFIT, LIUQE, CLISTE)
      transport:
        description: Transport analysis (ASTRA, TRANSP, JETTO)
      mhd:
        description: MHD stability analysis
      heating:
        description: Heating deposition codes (TORAY, TORBEAM, NUBEAM)
      control:
        description: Real-time plasma control systems
      profile_fitting:
        description: Profile fitting and kinetic analysis
      integrated:
        description: Integrated modeling workflows

  ServerRole:
    description: Role of a data server in the facility infrastructure
    permissible_values:
      primary:
        description: Main production data server
      secondary:
        description: Backup or read-replica server
      legacy:
        description: Historical/archived data server
      realtime:
        description: Real-time control system data
      analysis:
        description: Analysis results server

  DataFormatType:
    description: Types of data storage formats
    permissible_values:
      mdsplus:
        description: MDSplus tree-based storage
      hdf5:
        description: HDF5 hierarchical data format
      netcdf:
        description: NetCDF scientific data format
      csv:
        description: Comma-separated values
      json:
        description: JSON data files
      mat:
        description: MATLAB .mat files
      idl:
        description: IDL save files
      imas:
        description: IMAS data format

  # Note: IngestionStatus, PathStatus, SourceFileStatus, AgentRunStatus,
  # EnrichmentStatus are defined in common.yaml with unified terminology.
  # See common.yaml for the design philosophy and value definitions.

  PopulationType:
    description: How tree nodes are populated with data
    permissible_values:
      static:
        description: Structure is fixed, always present
      dynamic:
        description: Nodes created at runtime by analysis codes
      hybrid:
        description: Mix of static structure with dynamic population

  ProgrammingLanguage:
    description: Programming languages for code examples
    permissible_values:
      python:
        description: Python source code
      matlab:
        description: MATLAB/Octave code
      fortran:
        description: Fortran source code
      idl:
        description: IDL (Interactive Data Language)
      tdi:
        description: TDI (Tree Data Interface) expressions
      cpp:
        description: C++ source code
      julia:
        description: Julia source code

  PathType:
    description: Types of filesystem paths at a facility
    permissible_values:
      code_directory:
        description: Directory containing analysis codes or scripts
      data_directory:
        description: Directory containing data files
      config_directory:
        description: Directory containing configuration files
      binary_directory:
        description: Directory containing executables

  DataReferenceType:
    description: Type of data reference found in source code
    permissible_values:
      mdsplus_path:
        description: Direct MDSplus tree path (e.g., \\RESULTS::PSI)
      tdi_call:
        description: TDI function call (e.g., tcv_eq("PSI", "LIUQE"))
      imas_path:
        description: IMAS data dictionary path (future)

  TreeNodeSource:
    description: How a TreeNode was discovered and ingested
    permissible_values:
      tree_introspection:
        description: >-
          Discovered via MDSplus tree introspection (getNodeWild).
          Path is the physical tree path. Has node_type.
      code_extraction:
        description: >-
          Extracted from source code via code_examples pipeline.
          Path may be abbreviated (no full hierarchy).
          May represent accessor-level path, not physical node.
      tdi_parameter:
        description: >-
          A parameter accepted by a TDI function (e.g., tcv_eq("PSI")).
          Not a physical tree path but a logical data accessor name.
          Links to TreeNode via accessor_function relationship.
      manual:
        description: Manually created during exploration or testing

  ArtifactType:
    description: Types of wiki-linked artifacts (non-HTML files)
    permissible_values:
      pdf:
        description: PDF document (manuals, papers, reports)
      presentation:
        description: PowerPoint/Keynote slides (.ppt, .pptx, .key)
      document:
        description: Word/text documents (.doc, .docx, .odt, .rtf)
      spreadsheet:
        description: Spreadsheet files (.xls, .xlsx, .csv)
      image:
        description: Image files (.png, .jpg, .gif, .svg)
      notebook:
        description: Computational notebooks (.nb, .ipynb)
      data:
        description: Data files (.mat, .hdf5, .nc)
      archive:
        description: Archive files (.zip, .tar, .gz)
      other:
        description: Other file types

# =============================================================================
# Core Classes
# =============================================================================

classes:
  Facility:
    description: >-
      A fusion research facility. Root node for facility-specific knowledge.
      Public fields are stored in the graph. Private fields (is_private: true)
      are stored in <facility>_private.yaml only.
    class_uri: facility:Facility
    attributes:
      # === PUBLIC FIELDS (graph + epfl.yaml) ===
      id:
        identifier: true
        description: Unique facility identifier (e.g., "epfl", "iter", "jet")
        required: true
      name:
        description: Human-readable facility name (e.g., "EPFL/TCV")
        required: true
      description:
        description: Facility description
      machine:
        description: Tokamak/stellarator name (e.g., "TCV", "ITER", "JET")
      location:
        description: Geographic location
      data_systems:
        description: Data systems available (e.g., "mdsplus", "uda")
        multivalued: true

      # === PRIVATE FIELDS (epfl_private.yaml only, never graphed) ===
      ssh_host:
        description: SSH host alias for connection
        annotations:
          is_private: true
      hostnames:
        description: Network hostnames for this facility
        multivalued: true
        annotations:
          is_private: true
      nfs_mounts:
        description: NFS mount points (JSON-encoded list)
        multivalued: true
        annotations:
          is_private: true
      paths:
        description: Key filesystem paths (JSON-encoded dict)
        annotations:
          is_private: true
      excludes:
        description: Paths/patterns to exclude during exploration (JSON-encoded)
        annotations:
          is_private: true
      tools:
        description: Tool availability map (JSON-encoded dict)
        annotations:
          is_private: true
      os_info:
        description: Operating system details (JSON-encoded)
        annotations:
          is_private: true
      python_info:
        description: Python environment details (JSON-encoded)
        annotations:
          is_private: true
      compilers:
        description: Compiler availability (JSON-encoded)
        annotations:
          is_private: true
      containers:
        description: Available container images (JSON-encoded)
        annotations:
          is_private: true
      exploration_notes:
        description: Free-form exploration notes
        multivalued: true
        annotations:
          is_private: true

  FacilityPath:
    description: >-
      A filesystem path at a remote facility for structured exploration.
      
      REQUIRED TOOLS (install at ~/bin before exploration):
      - rg (ripgrep): Fast pattern search with --max-depth, --max-count limits
      - fd: Fast file finder, safer than find for large directories
      - dust: Disk usage visualization (~10x faster than du)
      - tokei: Lines of code by language (parallel, very fast)
      - scc: SLOC + complexity metrics for prioritization
      
      MULTI-PASS EXPLORATION WORKFLOW:
      1. Scout: discovered -> listed -> scanned (pattern search with rg)
      2. Triage: scanned -> flagged (use scc complexity for interest_score) or skipped
      3. Analyze: flagged -> analyzed (read files, understand structure)
      4. Ingest: analyzed -> ingested (create CodeExample nodes)
      
      Query paths by status to find work for each pass.
      Use interest_score to prioritize flagged paths.
    class_uri: facility:FacilityPath
    attributes:
      id:
        identifier: true
        description: Composite key as facility:path (e.g., "epfl:/home/codes")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      path:
        description: Absolute filesystem path
        required: true
      path_type:
        description: Type of path
        range: PathType
        required: true
      status:
        description: Exploration status
        range: PathStatus
        required: true
      parent_path_id:
        description: Parent directory path ID (null for root paths)
        range: FacilityPath
      depth:
        description: Distance from root path (0 = root like /home/codes)
        range: integer
      description:
        description: Human-readable description of what this path contains
      discovered_at:
        description: When this path was first discovered
        range: datetime
      last_examined:
        description: When this path was last examined by any pass
        range: datetime
      # Coverage tracking
      file_count:
        description: Total files in directory (set during listing)
        range: integer
      dir_count:
        description: Total subdirectories (set during listing)
        range: integer
      files_scanned:
        description: Files that matched patterns during scanning
        range: integer
      files_ingested:
        description: Files extracted to CodeExample nodes
        range: integer
      # Scout guidance
      interest_score:
        description: Priority for investigation (0.0-1.0, higher = more interesting)
        range: float
      patterns_found:
        description: Patterns that matched during scanning (e.g., "equilibrium", "IMAS")
        multivalued: true
      notes:
        description: Free-form notes about this path (append, don't overwrite)

# =============================================================================
# Data Infrastructure Classes (Public - no IPs or paths)
# =============================================================================

  MDSplusServer:
    description: An MDSplus data server (internal name only, no IP)
    class_uri: facility:MDSplusServer
    attributes:
      hostname:
        identifier: true
        description: Server name (e.g., "tcvdata", not IP address)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      role:
        description: Server role in the infrastructure
        range: ServerRole
      description:
        description: What data this server hosts

  MDSplusTree:
    description: An MDSplus tree (hierarchical data container)
    class_uri: facility:MDSplusTree
    attributes:
      name:
        identifier: true
        description: Tree name (e.g., "tcv_shot", "results")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      server_hostname:
        description: Primary server hosting this tree
        range: MDSplusServer
      description:
        description: Tree description
      shot_dependent:
        description: Whether tree structure varies by shot
        range: boolean
        ifabsent: "true"
      population_type:
        description: How nodes are populated (static, dynamic, hybrid)
        range: PopulationType
      # Ingestion tracking
      ingestion_status:
        description: Current ingestion status
        range: IngestionStatus
      node_count_total:
        description: Total known nodes in tree (from introspection)
        range: integer
      node_count_ingested:
        description: Number of nodes ingested to graph
        range: integer
      tdi_function_count:
        description: Number of TDI functions accessing this tree
        range: integer
      last_ingested:
        description: When tree structure was last ingested
        range: datetime
      reference_shot:
        description: Shot number used for structure introspection
        range: integer

  TreeModelVersion:
    description: >-
      A structural version of an MDSplus tree model. Captures when the
      tree structure changed and what nodes were added/removed. Enables
      the "super tree" concept where each node has applicability ranges.
    class_uri: facility:TreeModelVersion
    attributes:
      id:
        identifier: true
        description: Composite ID like epfl:results:v67
        required: true
      tree_name:
        description: Parent tree name
        required: true
        range: MDSplusTree
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      version:
        description: Sequential version number for this tree structure
        required: true
        range: integer
      first_shot:
        description: First shot where this structure was active
        required: true
        range: integer
      last_shot:
        description: Last shot with this structure (null = current model)
        range: integer
      node_count:
        description: Total nodes in this version
        range: integer
      nodes_added:
        description: Nodes added from previous version
        range: integer
      nodes_removed:
        description: Nodes removed from previous version
        range: integer
      added_subtrees:
        description: Top-level subtrees added in this version (e.g., ["BARATRON", "BOLO"])
        multivalued: true
      removed_subtrees:
        description: Top-level subtrees removed in this version
        multivalued: true
      predecessor:
        description: Previous structure version
        range: TreeModelVersion
      discovery_date:
        description: When this epoch was discovered
        range: datetime

  TreeNode:
    description: >-
      A node within an MDSplus tree. Represents a single data point that can
      be mapped to IMAS. Nodes with variants (PSI, PSI_2, PSI_3) are stored
      as a single node with a variants array, each linked to its source code.
    mixins:
      - LLMProvenance
    class_uri: facility:TreeNode
    attributes:
      path:
        identifier: true
        description: Full node path (e.g., "\\RESULTS::LIUQE:PSI")
        required: true
      tree_name:
        description: Parent tree name
        required: true
        range: MDSplusTree
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      node_type:
        description: MDSplus node data type
        range: TreeNodeType
      source:
        description: How this node was discovered and ingested
        range: TreeNodeSource
      canonical_path:
        description: >-
          Canonical form of the path for deduplication and matching.
          Normalized to single backslash, uppercase, no channel indices.
          Used for fuzzy matching when exact path doesn't match.
      physical_path:
        description: >-
          The actual MDSplus tree path (if different from accessor name).
          For tdi_parameter nodes, this links to the physical storage.
          E.g., tdi_parameter "I_P" -> physical_path "\\RESULTS::TOP.EQ_RECON.TRACES:I_P"
      unit:
        description: Physical units for this node (linked via HAS_UNIT relationship)
        range: Unit
      description:
        description: Node description
      physics_domain:
        description: Physics domain for categorization and filtering
      example_shot:
        description: Example shot number where this node exists
        range: integer
      variants:
        description: >-
          Variant suffixes for multi-source nodes (e.g., ["", "_2", "_3"] for 
          PSI, PSI_2, PSI_3 from LIUQE, LIUQE02, LIUQE03). First element is
          the primary/canonical path. Order matches source priority.
        multivalued: true
      variant_sources:
        description: >-
          Analysis codes that produce each variant (parallel array to variants).
          E.g., ["LIUQE", "LIUQE02", "LIUQE03"] for variants ["", "_2", "_3"].
        multivalued: true
        range: AnalysisCode
      shape:
        description: Data shape description (e.g., "1D time series", "2D profile(rho, time)")
      accessor_function:
        description: TDI function that provides high-level access to this node
        range: TDIFunction
      population_type:
        description: How this node is populated (static structure vs dynamic by analysis)
        range: PopulationType
      aliases:
        description: >-
          Alternative names for this node used by accessor functions.
          E.g., FORTRAN name "I_P" for MATLAB node "I_PL" in tcv_eq.
          First entry is the canonical/preferred name for the accessor.
        multivalued: true
      parent_path:
        description: >-
          Path to parent node (computed from path at ingestion time).
          Enables hierarchy traversal without explicit relationships.
          Null for root nodes (tree level).
          Example: \\RESULTS::LIUQE:PSI -> \\RESULTS::LIUQE
        range: string
      # Applicability range ("super tree" concept)
      first_shot:
        description: >-
          First shot where this node exists in tree structure.
          Null means node exists since earliest known shot.
        range: integer
      last_shot:
        description: >-
          Last shot where this node exists. Null means node exists
          in current model (still active).
        range: integer
      introduced_version:
        description: The tree model version that introduced this node
        range: TreeModelVersion
      removed_version:
        description: The tree model version that removed this node (rare)
        range: TreeModelVersion
      # IMAS mapping preparation fields
      sign_convention:
        description: >-
          Sign convention for this quantity. Critical for IMAS mapping.
          Examples: "positive clockwise from above", "positive outward",
          "positive = current flowing counter-clockwise (COCOS 11)".
          Include COCOS reference if known.
      dimensions:
        description: >-
          Array dimension names in order, like xarray dims.
          E.g., ["time", "rho"], ["R", "Z", "time"], ["channel", "time"].
          Critical for IMAS mapping where dimension semantics matter.
        multivalued: true
      error_nodes:
        description: >-
          Associated error/uncertainty TreeNodes linked via HAS_ERROR relationship.
          E.g., for a data node like \\RESULTS::THOMSON:NE, links to error nodes
          like \\RESULTS::THOMSON:NE:ERROR_BAR or \\RESULTS::THOMSON:NE:ERROR_UPPER.
        multivalued: true
        range: TreeNode
      enrichment_source:
        description: Source of enrichment (llm_agent, manual, wiki, mdsplus)
      enrichment_confidence:
        description: >-
          Computed confidence score (0.0-1.0) based on objective signals:
          has code context, has IMAS mapping, has units, description quality.
        range: float
      enrichment_status:
        description: >-
          Lifecycle status controlling enrichment workflow.
          Nodes start as 'pending', become 'enriched' after LLM pass,
          and 'reviewed' after human validation.
        range: EnrichmentStatus
      enrichment_notes:
        description: Agent reasoning or notes about the enrichment

  TDIFunction:
    description: >-
      A TDI function providing high-level data access abstraction.
      TDI functions encapsulate tree navigation and source selection logic,
      e.g., tcv_eq("PSI", "LIUQE") handles LIUQE/FBTE equilibrium selection.
      
      Version info: TCV uses VERSION.FUN to track shot-range validity.
      Pattern: _verss array maps to _shots array, bsearch selects version.
      Return -1 means not applicable, -2 means undefined program.
    class_uri: facility:TDIFunction
    attributes:
      name:
        identifier: true
        description: Function name (e.g., "tcv_eq", "tcv_ip")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      description:
        description: Function description and usage notes
      signature:
        description: Function signature with parameter types (e.g., "tcv_eq(signal, source, shot)")
      parameters:
        description: Function parameter names
        multivalued: true
      return_type:
        description: Return type description
      source_file:
        description: Path to the .FUN file defining this function
        range: FacilityPath
      physics_domain:
        description: Physics domain this function serves
      # Version and shot-range validity
      version:
        description: Current version number (from VERSION.FUN lookup)
        range: float
      valid_from_shot:
        description: First shot this function is valid for
        range: integer
      valid_to_shot:
        description: Last shot this function is valid for (null = current)
        range: integer
      version_history:
        description: JSON-encoded version history [{version, from_shot, to_shot}, ...]
      superseded_by:
        description: Name of replacement function if deprecated
        range: TDIFunction
      # Source selection for multi-source functions
      default_source:
        description: Default equilibrium/analysis source (e.g., "LIUQE")
      available_sources:
        description: Available source selections (e.g., ["LIUQE", "LIUQE2", "FBTE"])
        multivalued: true
      supported_quantities:
        description: >-
          Quantity names this function accepts as first argument.
          E.g., ["I_P", "R_AXIS", "PSI_AXIS", "Q_95", ...] for tcv_eq.
          Use TreeNode.aliases for name translation (FORTRANâ†”MATLAB).
        multivalued: true
      quantity_definitions:
        description: >-
          JSON-encoded map of quantity name to definition.
          E.g., {"AMIN": {"expression": "tcv_eq(\"R_CONTOUR\") - R_AXIS", 
          "dependencies": ["R_CONTOUR", "R_AXIS"]}}
      quantity_categories:
        description: >-
          JSON-encoded map of category to quantity names.
          E.g., {"shape": ["AMIN", "KAPPA", "DELTA"], "energy": ["WE", "W_MHD"]}

  ShotRange:
    description: A range of shot numbers with common characteristics
    class_uri: facility:ShotRange
    attributes:
      id:
        identifier: true
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      name:
        description: Name or description of this range
      start_shot:
        description: First shot number
        range: integer
      end_shot:
        description: Last shot number (null if ongoing)
        range: integer
      description:
        description: What this shot range represents

# =============================================================================
# Data Semantics Classes
# =============================================================================

  Diagnostic:
    description: A plasma diagnostic system
    class_uri: facility:Diagnostic
    attributes:
      name:
        identifier: true
        description: Diagnostic name (e.g., "Thomson", "ECE", "MSE")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      category:
        description: Diagnostic category
        range: DiagnosticCategory
      description:
        description: Diagnostic description

  AnalysisCode:
    description: >-
      A physics analysis or simulation code that writes data to trees.
      Links to the TreeNode variants it produces (e.g., LIUQE writes PSI, PSI_2).
      Version info tracks which shots used which code version.
    class_uri: facility:AnalysisCode
    attributes:
      name:
        identifier: true
        description: Code name (e.g., "LIUQE", "ASTRA", "TORAY")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      code_type:
        description: Type of analysis
        range: AnalysisCodeType
      description:
        description: Code description
      version:
        description: Code version if known
      installed_at:
        description: Installation path (links to FacilityPath)
        range: FacilityPath
      # Shot-range validity
      valid_from_shot:
        description: First shot this code version is valid for
        range: integer
      valid_to_shot:
        description: Last shot this code version is valid for (null = current)
        range: integer
      version_history:
        description: JSON-encoded version history [{version, from_shot, to_shot}, ...]
      # Output relationships
      writes_to_tree:
        description: Tree this code writes results to
        range: MDSplusTree
      output_variant:
        description: Variant suffix for this code's output (e.g., "_2" for LIUQE02)
      supersedes:
        description: Previous version of this code it replaces
        range: AnalysisCode

# =============================================================================
# IMAS Mapping Classes
# =============================================================================

# NOTE: IMASPath is now defined in imas_dd.yaml as the unified representation
# of IMAS Data Dictionary paths. Do not define it here.

  IMASMapping:
    description: >-
      A mapping from facility-specific data to IMAS paths.
      Contains all information needed to generate an Ambix Recipe for data pumping.
      Data flow is one-way (facility->IMAS) but searchable from either direction.
    mixins:
      - LLMProvenance
    class_uri: facility:IMASMapping
    attributes:
      id:
        identifier: true
        required: true
      source_path:
        description: Source facility path (TreeNode path or TDI function call)
        required: true
        range: TreeNode
      target_path:
        description: Target IMAS path
        required: true
        range: IMASPath
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      
      # Pump context for Ambix Recipe generation
      driver:
        description: Data access driver (e.g., "mdsplus", "tdi", "ppf")
        range: DataSourceType
        required: true
      driver_args:
        description: Arguments for the driver (JSON-encoded, e.g., tree name, path)
      units_in:
        description: Units of the source data (must be pint-compatible)
      units_out:
        description: Units of the target IMAS path (from IMAS DD)
      scale:
        description: Numeric scale factor for transformation
        range: float
      transformation:
        description: Complex transformation expression if scale is insufficient
      
      # Validation and provenance
      validated:
        description: Whether this mapping has been validated against real data
        range: boolean
      validated_shot:
        description: Shot number used for validation
        range: integer
      confidence:
        description: Confidence level of the mapping (0.0-1.0)
        range: float
      notes:
        description: Mapping notes and caveats

# =============================================================================
# Code Examples Classes
# =============================================================================

  CodeExample:
    description: >-
      A code file containing examples of reading/writing fusion data.
      Links to facility and tracks source location for provenance.
    class_uri: facility:CodeExample
    attributes:
      id:
        identifier: true
        description: Unique identifier (facility:filename hash)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      source_file:
        description: Remote file path (e.g., /home/wilson/data/load_to_imas.py)
        required: true
      language:
        description: Programming language
        range: ProgrammingLanguage
        required: true
      title:
        description: Human-readable title or filename
      description:
        description: Description of what this code does
      author:
        description: Username or author name if known
      related_ids:
        description: IDS names this code interacts with (coarse linking)
        multivalued: true
      ingested_at:
        description: Timestamp when this was ingested
        range: datetime

  SourceFile:
    description: >-
      A source file queued for ingestion into the knowledge graph.
      
      Lifecycle: queued -> fetching -> embedding -> ready
      On failure: any state -> failed (check error field)
      On re-scan: ready -> stale -> queued (if changed)
      
      SourceFile is the unit of work for the ingestion pipeline.
      Scouts create SourceFile nodes; CLI processes them.
      When ready, a CodeExample node is created with chunks.
    class_uri: facility:SourceFile
    attributes:
      id:
        identifier: true
        description: Composite key as facility:path (e.g., epfl:/home/codes/foo.py)
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      path:
        description: Absolute remote filesystem path
        required: true
      status:
        description: Current lifecycle status
        range: SourceFileStatus
        required: true
      language:
        description: Programming language (detected from extension)
        range: ProgrammingLanguage
      parent_path_id:
        description: FacilityPath that contains this file (for tracking)
        range: FacilityPath
      discovered_by:
        description: Scout session or pattern that found this file
      discovered_at:
        description: When this file was queued for ingestion
        range: datetime
      interest_score:
        description: Priority score from scout (0.0-1.0, higher = more interesting)
        range: float
      patterns_matched:
        description: Patterns that matched during discovery (e.g., "IMAS", "equilibrium")
        multivalued: true
      # Processing metadata
      started_at:
        description: When ingestion started (fetching state)
        range: datetime
      completed_at:
        description: When ingestion completed (ready state)
        range: datetime
      error:
        description: Error message if status is failed
      retry_count:
        description: Number of retry attempts
        range: integer
      # Output
      code_example_id:
        description: ID of created CodeExample (set when ready)
        range: CodeExample

  CodeChunk:
    description: >-
      A searchable chunk of code from a CodeExample.
      Contains embedding for semantic search. Data references are linked
      via DataReference nodes, not stored as arrays.
    class_uri: facility:CodeChunk
    attributes:
      id:
        identifier: true
        description: Unique chunk identifier
        required: true
      code_example_id:
        description: Parent CodeExample
        required: true
        range: CodeExample
      content:
        description: The actual code content
        required: true
      function_name:
        description: Function or class name if applicable
      start_line:
        description: Starting line number in source file
        range: integer
      end_line:
        description: Ending line number in source file
        range: integer
      embedding:
        description: Vector embedding for semantic search (stored as list of floats)
        multivalued: true
        range: float
      ref_count:
        description: Count of DataReference nodes linked to this chunk
        range: integer

  DataReference:
    description: >-
      A reference to external data found in source code.
      Preserves the exact string as found for provenance.
      Resolution to actual data nodes happens via typed relationships.
    class_uri: facility:DataReference
    attributes:
      id:
        identifier: true
        description: Composite key (facility:type:hash of raw_string)
        required: true
      raw_string:
        description: Exact string as found in code (e.g., "\\RESULTS::PSI")
        required: true
      normalized_path:
        description: >-
          Normalized path for fuzzy matching. Strips channel indices and
          suffixes to match tree structure nodes. E.g., CHANNEL_006 -> CHANNEL.
          Used when raw_string doesn't match any TreeNode exactly.
      ref_type:
        description: Type of data reference
        required: true
        range: DataReferenceType
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      # Typed resolution relationships
      resolves_to_tree_node:
        description: MDSplus TreeNode this reference resolves to
        range: TreeNode
        multivalued: true
      calls_tdi_function:
        description: TDI function being called (for tdi_call type)
        range: TDIFunction
      resolves_to_imas_path:
        description: IMAS path this reference resolves to (future)
        range: IMASPath
        multivalued: true

  AgentRun:
    description: >-
      Tracks a long-running agent execution for resumability and audit.
      
      Agents (discover-paths, discover-files, discover-tdi, enrich, map)
      create an AgentRun at start and update it periodically with checkpoints.
      On crash, the agent can resume from last_item_id.
      
      Budget fields enable cost/time controls for autonomous execution.
    class_uri: facility:AgentRun
    attributes:
      id:
        identifier: true
        description: UUID for this run (e.g., "epfl-discover-paths-20260107-1234")
        required: true
      facility_id:
        description: Target facility for this agent run
        required: true
        range: Facility
      agent_type:
        description: Type of agent (discover-paths, discover-files, discover-tdi, enrich, map)
        required: true
      started_at:
        description: When the agent run started
        range: datetime
        required: true
      ended_at:
        description: When the agent run completed (null if still running)
        range: datetime
      status:
        description: Current run status
        range: AgentRunStatus
        required: true
      budget_seconds:
        description: Maximum allowed run time in seconds (null = no limit)
        range: integer
      budget_cost:
        description: Maximum allowed cost in USD (null = no limit)
        range: float
      actual_cost:
        description: Actual cost incurred so far
        range: float
      items_total:
        description: Total items to process (if known at start)
        range: integer
      items_processed:
        description: Number of items processed so far
        range: integer
      items_skipped:
        description: Number of items skipped (already done, excluded)
        range: integer
      items_failed:
        description: Number of items that failed processing
        range: integer
      last_item_id:
        description: ID of last successfully processed item (for resumption)
      last_checkpoint_at:
        description: When the last checkpoint was saved
        range: datetime
      error_message:
        description: Error message if status=failed
      error_traceback:
        description: Python traceback if available
      config:
        description: JSON-encoded agent configuration (root paths, patterns, etc.)
      llm_model:
        description: LLM model used (e.g., "google/gemini-3-flash-preview")
      llm_calls:
        description: Number of LLM calls made
        range: integer
      tokens_used:
        description: Total tokens consumed
        range: integer

# =============================================================================
# Wiki Documentation Classes
# =============================================================================

  WikiPage:
    description: >-
      A wiki page from facility documentation (e.g., TCV wiki).
      Contains authoritative signal descriptions, conventions, and specs.
      
      Three-phase lifecycle:
      1. CRAWL: Extract links, create nodes with status=crawled, build LINKS_TO graph
      2. SCORE: Agent evaluates graph metrics, assigns interest_score, updates status
      3. INGEST: Fetch content for high-score pages, create WikiChunks
      
      Relationships:
      - LINKS_TO -> WikiPage (wiki link structure, created during crawl)
      - FACILITY_ID -> Facility
      - MENTIONS_TREE_NODE -> TreeNode (created during ingest)
      - MENTIONS_DIAGNOSTIC -> Diagnostic
      - MENTIONS_CODE -> AnalysisCode
      - MENTIONS_DOMAIN -> PhysicsDomain
      - HAS_CHUNK -> WikiChunk (created during ingest)
    mixins:
      - LLMProvenance
    class_uri: facility:WikiPage
    attributes:
      id:
        identifier: true
        description: Composite key as facility:page_name (e.g., "epfl:Thomson")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      url:
        description: Original wiki URL
        required: true
      title:
        description: Page title (extracted from wiki, may differ from page_name)
        required: true
      status:
        description: Lifecycle status (crawled -> scored -> discovered/skipped -> ingested)
        range: WikiPageStatus
        required: true
      
      # Graph structure fields (computed during crawl)
      link_depth:
        description: Distance from portal page (0=portal, 1=direct link, etc.)
        range: integer
      in_degree:
        description: Number of pages linking TO this page (computed from LINKS_TO)
        range: integer
      out_degree:
        description: Number of pages this links TO (computed from LINKS_TO)
        range: integer
      links_to:
        description: Pages this page links to (wiki structure preserved as relationships)
        range: WikiPage
        multivalued: true
        inlined: false
        annotations:
          relationship_type: LINKS_TO
      
      # Scoring fields (set by agent during score phase)
      interest_score:
        description: >-
          Agent-assigned priority score (0.0-1.0). Computed from graph metrics:
          in_degree, out_degree, link_depth, neighbor scores, title keywords.
        range: float
      score_reasoning:
        description: Agent's explanation for the interest_score assignment
      skip_reason:
        description: >-
          Why the agent marked this page as skipped. Grounded in metrics.
          Examples: "in_degree=0, no pages reference this", "link_depth=5, too far from portal"
      
      # Discovery metadata
      discovered_at:
        description: When this page was first crawled
        range: datetime
      scored_at:
        description: When the agent assigned interest_score
        range: datetime
      
      # Ingestion fields
      content_hash:
        description: SHA256 hash of content for change detection (first 16 chars)
      preview_size:
        description: Size of page content in bytes
        range: integer
      last_scraped:
        description: When this page was last fully scraped for ingestion
        range: datetime
      chunk_count:
        description: Number of WikiChunk nodes created from this page
        range: integer
      error:
        description: Error message if status is failed

  WikiChunk:
    description: >-
      A searchable chunk from a wiki page with vector embeddings.
      Uses same embedding model as CodeChunk for unified semantic search.
      
      Relationships created during ingestion:
      - DOCUMENTS -> TreeNode (MDSplus paths documented in chunk)
      - MENTIONS_IMAS -> IMASPath
      - MENTIONS_UNIT -> Unit
      - MENTIONS_CONVENTION -> SignConvention
    class_uri: facility:WikiChunk
    attributes:
      id:
        identifier: true
        description: Unique chunk identifier (e.g., "epfl:Thomson:chunk_0")
        required: true
      wiki_page_id:
        description: Parent WikiPage ID
        required: true
        range: WikiPage
      facility_id:
        description: Facility for efficient filtering
        required: true
        range: Facility
      section:
        description: Section heading this chunk belongs to
      content:
        description: The actual text content
        required: true
      start_char:
        description: Starting character offset in original page
        range: integer
      end_char:
        description: Ending character offset in original page
        range: integer
      embedding:
        description: Vector embedding for semantic search (384-dim, all-MiniLM-L6-v2)
        multivalued: true
        range: float

  WikiArtifact:
    description: >-
      A linked artifact (PDF, PowerPoint, image, etc.) discovered during wiki crawl.
      Created during Phase 1 when links to non-wiki files are found.
      
      These artifacts are NOT crawlable wiki pages - they are binary files.
      The scoring phase (Phase 2) evaluates them based on:
      - Filename keywords (e.g., "ASTRA_manual", "IpB0signs")
      - in_degree: how many wiki pages link to this artifact
      - Linking page context (if linked from diagnostic pages -> likely technical)
      
      Phase 3 ingestion is deferred - requires OCR or specialized parsers.
      
      Relationships:
      - FACILITY_ID -> Facility
      - LINKED_FROM -> WikiPage (pages that link to this artifact)
    class_uri: facility:WikiArtifact
    attributes:
      id:
        identifier: true
        description: Composite key as facility:filename (e.g., "epfl:ASTRA_manual.pdf")
        required: true
      facility_id:
        description: Parent facility ID
        required: true
        range: Facility
      url:
        description: Full URL to artifact
        required: true
      filename:
        description: Extracted filename (e.g., "ASTRA_manual_with_index.pdf")
        required: true
      artifact_type:
        description: Type of artifact
        range: ArtifactType
        required: true
      status:
        description: Lifecycle status
        range: WikiArtifactStatus
        required: true
      
      # Graph metrics (computed during crawl)
      in_degree:
        description: Number of wiki pages linking TO this artifact
        range: integer
      link_depth:
        description: Minimum link depth of pages linking to this artifact
        range: integer
      
      # Scoring fields (set by agent during score phase)
      interest_score:
        description: >-
          Agent-assigned priority score (0.0-1.0). Computed from:
          filename keywords, in_degree, linking page context.
        range: float
      score_reasoning:
        description: Agent's explanation for the interest_score assignment
      skip_reason:
        description: Why the agent marked this artifact as skipped
      
      # Content hints inferred from filename/context
      physics_domains:
        description: Physics domains inferred from filename/context
        multivalued: true
      codes_mentioned:
        description: Analysis codes inferred from filename
        multivalued: true
      
      # Timestamps
      discovered_at:
        description: When this artifact was first discovered
        range: datetime
      scored_at:
        description: When the agent assigned interest_score
        range: datetime
      
      # Error tracking
      error:
        description: Error message if status is failed
