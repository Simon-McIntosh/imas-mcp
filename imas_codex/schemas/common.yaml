# Common Graph Schema
#
# This schema defines shared graph entities used across multiple domains.
# These are cross-cutting types that bridge IMAS DD and facility-specific data.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force

id: https://imas.iter.org/schemas/common
name: common
title: Common Graph Schema
description: >-
  Shared graph entities used across IMAS DD and facility-specific schemas.
  These types enable cross-linking between different data domains.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  common: https://imas.iter.org/schemas/common/

default_prefix: common
default_range: string

imports:
  - linkml:types

# =============================================================================
# Status Enums - Unified Lifecycle Terminology
# =============================================================================
#
# Design Philosophy:
# - Status represents lifecycle phase, not current activity
# - Progress is derived from graph relationships and properties
# - Consistent vocabulary: same words mean the same thing everywhere
#
# Common Pattern:
#   discovered -> [domain-specific completion] -> stale
#
# Where:
#   - "discovered" = entity found, in graph, awaiting processing
#   - completion term = domain-specific past tense (ingested/explored/enriched)
#   - "stale" = may need re-processing (optional)
#   - "skipped/failed/cancelled" = terminal alternatives where applicable

enums:
  IngestionStatus:
    description: >-
      Lifecycle status for MDSplus tree structure ingestion.
      Tracks whether TreeNodes have been added to the graph.
      Progress is graph-derived: compare node_count_ingested vs node_count_total.
    permissible_values:
      discovered:
        description: Tree found in facility, awaiting node ingestion
      ingested:
        description: All known nodes added to graph
      stale:
        description: Tree may have new nodes, needs re-introspection

  PathStatus:
    description: >-
      Lifecycle status for facility path exploration.
      Progress is graph-derived: check file_count, child SourceFile nodes.
    permissible_values:
      discovered:
        description: Path found, awaiting exploration
      explored:
        description: Fully examined, all files queued for ingestion
      skipped:
        description: Intentionally not exploring (low value or blocklisted)
      stale:
        description: Path may no longer exist or has changed

  SourceFileStatus:
    description: >-
      Lifecycle status for source file ingestion pipeline.
      Progress is graph-derived: count CodeExample nodes linked to file.
    permissible_values:
      discovered:
        description: File found, awaiting ingestion
      ingested:
        description: Code extracted, CodeExample nodes created
      failed:
        description: Ingestion failed (check error property)
      stale:
        description: Source may have changed, needs re-fetch

  AgentRunStatus:
    description: >-
      Lifecycle status for autonomous agent runs.
      Progress is graph-derived: items_processed / items_total.
    permissible_values:
      created:
        description: Run initialized, not yet started
      running:
        description: Currently executing
      completed:
        description: Successfully finished all work
      failed:
        description: Stopped due to error
      cancelled:
        description: Stopped by user request

  EnrichmentStatus:
    description: >-
      Lifecycle status for LLM metadata enrichment of TreeNodes.
      Progress is graph-derived: check for HAS_UNIT, MAPS_TO relationships.
    permissible_values:
      discovered:
        description: Node in graph, awaiting LLM enrichment
      enriched:
        description: Successfully enriched with metadata
      stale:
        description: Needs re-enrichment (new context available)

# =============================================================================
# Classes
# =============================================================================

classes:
  LLMProvenance:
    description: >-
      Mixin providing provenance tracking for LLM-generated or LLM-enriched content.
      Use on any class where agents modify data to enable re-enrichment workflows.
      
      Enables queries like:
      - Mark all nodes enriched by model X as stale
      - Re-enrich all nodes enriched before date Y
      - Compare quality across models
    mixin: true
    class_uri: common:LLMProvenance
    attributes:
      enrichment_model:
        description: >-
          LLM model identifier used for enrichment (e.g., "google/gemini-3-pro-preview").
          Enables bulk re-enrichment when upgrading models.
      enrichment_at:
        description: >-
          ISO timestamp when LLM enrichment was performed.
          Enables time-based re-enrichment policies.
        range: datetime

  Unit:
    description: >-
      A physical unit used in both IMAS Data Dictionary and facility-specific
      data. Units are deduplicated across all paths to enable unit-based queries
      and cross-linking between IMAS paths and MDSplus TreeNodes.
      
      Both IMASPath and TreeNode link to Unit via HAS_UNIT relationships,
      enabling queries like "find all paths (IMAS or facility) using Weber".
    class_uri: common:Unit
    attributes:
      symbol:
        identifier: true
        description: Unit symbol (e.g., "Wb", "m.s^-1", "eV", "A")
        required: true
      name:
        description: Human-readable name (e.g., "Weber", "meters per second")
      dimension:
        description: Physical dimension category (e.g., "magnetic_flux", "velocity")
      is_si:
        description: Whether this is an SI base or derived unit
        range: boolean
