# Common Graph Schema
#
# This schema defines shared graph entities used across multiple domains.
# These are cross-cutting types that bridge IMAS DD and facility-specific data.
#
# Generated models: imas_codex/graph/models.py
# To regenerate: uv run build-models --force

id: https://imas.iter.org/schemas/common
name: common
title: Common Graph Schema
description: >-
  Shared graph entities used across IMAS DD and facility-specific schemas.
  These types enable cross-linking between different data domains.

license: MIT
version: 0.4.0

prefixes:
  linkml: https://w3id.org/linkml/
  common: https://imas.iter.org/schemas/common/

default_prefix: common
default_range: string

imports:
  - linkml:types

# =============================================================================
# Status Enums - Unified Lifecycle Terminology
# =============================================================================
#
# Design Philosophy:
# - Status represents lifecycle phase, not current activity
# - Progress is derived from graph relationships and properties
# - Consistent vocabulary: same words mean the same thing everywhere
#
# Common Pattern:
#   discovered -> [domain-specific completion] -> stale
#
# Where:
#   - "discovered" = entity found, in graph, awaiting processing
#   - completion term = domain-specific past tense (ingested/explored/enriched)
#   - "stale" = may need re-processing (optional)
#   - "skipped/failed/cancelled" = terminal alternatives where applicable

enums:
  IngestionStatus:
    description: >-
      Lifecycle status for MDSplus tree structure ingestion.
      Tracks whether TreeNodes have been added to the graph.
      Progress is graph-derived: compare node_count_ingested vs node_count_total.
    permissible_values:
      discovered:
        description: Tree found in facility, awaiting node ingestion
      ingested:
        description: All known nodes added to graph
      stale:
        description: Tree may have new nodes, needs re-introspection

  PathStatus:
    description: >-
      Lifecycle status for facility path exploration.
      Progress is graph-derived: check file_count, child SourceFile nodes.
    permissible_values:
      discovered:
        description: Path found, awaiting exploration
      explored:
        description: Fully examined, all files queued for ingestion
      skipped:
        description: Intentionally not exploring (low value or blocklisted)
      stale:
        description: Path may no longer exist or has changed

  SourceFileStatus:
    description: >-
      Lifecycle status for source file ingestion pipeline.
      Progress is graph-derived: count CodeExample nodes linked to file.
    permissible_values:
      discovered:
        description: File found, awaiting ingestion
      ingested:
        description: Code extracted, CodeExample nodes created
      failed:
        description: Ingestion failed (check error property)
      stale:
        description: Source may have changed, needs re-fetch

  AgentRunStatus:
    description: >-
      Lifecycle status for autonomous agent runs.
      Progress is graph-derived: items_processed / items_total.
    permissible_values:
      created:
        description: Run initialized, not yet started
      running:
        description: Currently executing
      completed:
        description: Successfully finished all work
      failed:
        description: Stopped due to error
      cancelled:
        description: Stopped by user request

  EnrichmentStatus:
    description: >-
      Lifecycle status for LLM metadata enrichment of TreeNodes.
      Progress is graph-derived: check for HAS_UNIT, MAPS_TO relationships.
    permissible_values:
      discovered:
        description: Node in graph, awaiting LLM enrichment
      enriched:
        description: Successfully enriched with metadata
      stale:
        description: Needs re-enrichment (new context available)

  WikiPageStatus:
    description: >-
      Lifecycle status for wiki page discovery and ingestion.
      Three-phase process: crawl (link extraction) -> score (agent evaluation) -> ingest (content).
    permissible_values:
      crawled:
        description: Page discovered via link crawl, graph structure captured, not yet scored
      scored:
        description: Agent has evaluated graph metrics and assigned interest_score
      discovered:
        description: High interest_score, ready for ingestion
      skipped:
        description: Low interest_score, agent decided not to ingest (check skip_reason)
      ingested:
        description: Full content scraped, chunked, embedded, and linked to graph
      failed:
        description: Processing failed at any phase (check error property)
      stale:
        description: Previously processed but content may have changed

  WikiArtifactStatus:
    description: >-
      Lifecycle status for wiki-linked artifacts (PDFs, presentations, etc.).
      Artifacts are discovered during crawl, scored by filename/context, but
      ingestion requires specialized processing (OCR, parsers).
    permissible_values:
      discovered:
        description: Artifact found during crawl, awaiting scoring
      scored:
        description: Agent has evaluated filename/context and assigned interest_score
      deferred:
        description: High-value but requires manual/OCR processing (future work)
      skipped:
        description: Low-value artifact, not worth processing
      failed:
        description: Processing failed (check error property)

  ConventionType:
    description: >-
      Types of physics conventions documented in wiki content.
      Used for SignConvention nodes extracted from wiki.
    permissible_values:
      cocos:
        description: COCOS (Coordinate Convention for Specifying Orientations)
      sign:
        description: Sign convention for physical quantities
      direction:
        description: Directional convention (positive/negative direction)
      coordinate:
        description: Coordinate system definition
      normalization:
        description: Normalization convention

# =============================================================================
# Classes
# =============================================================================

classes:
  LLMProvenance:
    description: >-
      Mixin providing provenance tracking for LLM-generated or LLM-enriched content.
      Use on any class where agents modify data to enable re-enrichment workflows.
      
      Enables queries like:
      - Mark all nodes enriched by model X as stale
      - Re-enrich all nodes enriched before date Y
      - Compare quality across models
    mixin: true
    class_uri: common:LLMProvenance
    attributes:
      enrichment_model:
        description: >-
          LLM model identifier used for enrichment (e.g., "google/gemini-3-pro-preview").
          Enables bulk re-enrichment when upgrading models.
      enrichment_at:
        description: >-
          ISO timestamp when LLM enrichment was performed.
          Enables time-based re-enrichment policies.
        range: datetime

  PhysicsDomain:
    description: >-
      Physics domain for categorizing fusion data and documentation.
      Used to link WikiPages, TreeNodes, and IMASPaths by physics topic.
      
      Examples: equilibrium, transport, mhd, heating, diagnostics
    class_uri: common:PhysicsDomain
    attributes:
      name:
        identifier: true
        description: Domain name (e.g., "equilibrium", "transport", "mhd")
        required: true
      description:
        description: Human-readable description of the domain

  Unit:
    description: >-
      A physical unit used in both IMAS Data Dictionary and facility-specific
      data. Units are deduplicated across all paths to enable unit-based queries
      and cross-linking between IMAS paths and MDSplus TreeNodes.
      
      Both IMASPath and TreeNode link to Unit via HAS_UNIT relationships,
      enabling queries like "find all paths (IMAS or facility) using Weber".
    class_uri: common:Unit
    attributes:
      symbol:
        identifier: true
        description: Unit symbol (e.g., "Wb", "m.s^-1", "eV", "A")
        required: true
      name:
        description: Human-readable name (e.g., "Weber", "meters per second")
      dimension:
        description: Physical dimension category (e.g., "magnetic_flux", "velocity")
      is_si:
        description: Whether this is an SI base or derived unit
        range: boolean

  SignConvention:
    description: >-
      A physics sign/orientation convention extracted from wiki documentation.
      Links to TreeNodes and IMASPaths that follow this convention.
      Critical for IMAS mapping correctness.
    class_uri: common:SignConvention
    attributes:
      id:
        identifier: true
        description: Unique identifier (e.g., "epfl:cocos:11", "epfl:sign:ip_positive_ccw")
        required: true
      facility_id:
        description: Facility where this convention applies
        required: true
      convention_type:
        description: Type of convention
        range: ConventionType
        required: true
      name:
        description: Short name (e.g., "COCOS 11", "Positive Ip CCW")
        required: true
      description:
        description: Full description of the convention
        required: true
      cocos_index:
        description: COCOS index number if applicable (1-18)
        range: integer
      wiki_source:
        description: URL of wiki page where this was documented
      applies_to_paths:
        description: MDSplus paths this convention applies to
        multivalued: true
      applies_to_imas:
        description: IMAS paths this convention applies to
        multivalued: true
